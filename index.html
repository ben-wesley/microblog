<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="shortcut icon" type="image/x-icon" href="favicon.ico?">
  <title>the microblog of benj wesley</title>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: 1em auto; padding: 0.5em; }
    article { margin-bottom: 1em; border-bottom: 1px solid #ddd; padding-bottom: 0.5em; }
    h1 { font-size: 1.4em; }
    img { max-width: 80%; height: auto; }
    button {
      background: #eee;
      border: none;
      padding: 0.5em 1em;
      margin: 0.5em;
      cursor: pointer;
      font-size: 1em;
      border-radius: 5px;
    }
button:hover {  background: #ddd; }
.read-more {
    background: #eee;
    border: none;
    padding: 0.4em 0.8em;
    margin-top: 0.5em;
    cursor: pointer;
    border-radius: 5px;
    font-size: 0.9em;
  }

  .read-more:hover {
    background: #ddd;
  }
  </style>
</head>
<body>
  <h1>the microblog of benj. wesley</h1>
  <hr>
  <div id="posts">Loading posts...</div>
  <div id="pagination" style="text-align: center; margin-top: 1em;"></div>

  <script>
  const username = 'ben-wesley';
  const repo = 'microblog';
  const folder = 'posts';
  const postsPerPage = 30;
  let currentPage = 0;
  let allPosts = [];

  async function fetchPostsList() {
    const apiUrl = `https://api.github.com/repos/${username}/${repo}/contents/${folder}`;
    const res = await fetch(apiUrl);
    const files = await res.json();
    return files
      .filter(file => file.name.endsWith('.md'))
      .sort((a, b) => b.name.localeCompare(a.name)); // newest first
  }

  async function loadPage(page) {
    const postList = document.getElementById('posts');
    postList.innerHTML = '';

    const start = page * postsPerPage;
    const end = start + postsPerPage;
    const pagePosts = allPosts.slice(start, end);

    for (const post of pagePosts) {
      const res = await fetch(post.download_url);
      const text = await res.text();
      const html = marked.parse(text);
      
      const article = document.createElement('article');
    
      const previewLimit = 750; // You can tweak this — chars or use line/paragraph logic
      if (text.length > previewLimit) {
        const previewText = text.slice(0, previewLimit);
        const previewHTML = marked.parse(previewText + '...');
        const fullHTML = html;
    
        article.innerHTML = `
          <div class="preview">${previewHTML}</div>
          <div class="full-content" style="display: none;">${fullHTML}</div>
          <button class="read-more">Read more</button>
        `;
    
        article.querySelector('.read-more').addEventListener('click', function () {
          article.querySelector('.preview').style.display = 'none';
          article.querySelector('.full-content').style.display = 'block';
          this.style.display = 'none'; // hide the button after expanding
        });
      } else {
        article.innerHTML = html; // if it's short, show full content
      }
    
      postList.appendChild(article);
}


    updatePaginationControls();
  }

  function updatePaginationControls() {
    const nav = document.getElementById('pagination');
    nav.innerHTML = '';

    if (currentPage > 0) {
      const newer = document.createElement('button');
      newer.textContent = '← Newer';
      newer.onclick = () => {
        currentPage--;
        loadPage(currentPage);
      };
      nav.appendChild(newer);
    }

    if ((currentPage + 1) * postsPerPage < allPosts.length) {
      const older = document.createElement('button');
      older.textContent = 'Older →';
      older.onclick = () => {
        currentPage++;
        loadPage(currentPage);
      };
      nav.appendChild(older);
    }
  }

  // Load Marked.js and start everything
  const script = document.createElement('script');
  script.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
  script.onload = async () => {
    allPosts = await fetchPostsList();
    loadPage(currentPage);
  };
  document.body.appendChild(script);
</script>

</body>
</html>
